function PhonoFus_Famil(hndl,start)
    % User GUI for familarization protocol
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Show Experimental Screen, Run Experiment
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

if ~exist('start','var')
    start = 0;
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% open experimental screen
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%set(hndl.StartFig,'visible','off');
if ~start
    hndl.ExpFig = figure('name','Famil',...
        'numbertitle','off',...
        'MenuBar','none',...
        'Visible','on','Units','normalized','Position',[0.,0.,1,1]);
    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 %% Stimulus Parameters   
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    
    % STIMULUS

    hndl.PracticeITDs = [200 400 600 800];
    hndl.UseTDT=0;
    hndl.SRate=44100;
    % n bursts
    
    % COLORS
    
    hndl.colors.white=[1 1 1];
    hndl.colors.gray=[0.9255 0.9137 0.8471];
    hndl.colors.green=[0.5 1 0.25];
    hndl.colors.blue=[0.5 0.5 1];
    hndl.colors.red=[1 0.25 0.25];
    hndl.colors.gray = [0.8 0.8 0.8];
    
    % WORD TO NUMBER MAP
    
    hndl.PosWords = {'Bed','Led','Red','Bled','Bread',...
                'Pay','Lay','Ray','Play','Pray',...
                'Go','Low','Row','Glow','Grow'};
            
    hndl.StimulusPath = '../Stimuli/';
    hndl.CalibStim = audioread('../Stimuli/PinkNoise.wav');
    hndl.RMSCalib = rms(hndl.CalibStim)^2;
    hndl.Ramp = 10;
    hndl.npanel = 5;
    set(gcf, 'UserData', hndl);
    hndl = get(gcf, 'UserData');
    
else
    
    clf(hndl.ExpFig);
    hndl.ExpButtons.Next = uicontrol('Style', 'pushbutton', 'String', 'Next', ...
        'FontWeight', 'bold', ...
        'FontSize', 8, ...
        'FontUnits','normalized',...
        'backgroundcolor',[1 0.1 0.1], ...
        'callback',{@WelcomeScreenHomeDelivery,hndl.npanel}, ...
        'Units', 'normalized', 'Position',[0.885,0.1,0.1,0.052]);

    hndl.ExpButtons.GetHelp = uicontrol('Style', 'pushbutton', 'String', 'Help', ...
        'FontWeight', 'bold', ...
        'FontSize', 8, ...
        'FontUnits','normalized',...
        'backgroundcolor',[1 0.1 0.1], ...
        'callback',{@Help,0}, ...
        'Units', 'normalized', 'Position',[0.115,0.1,0.1,0.052]);
    
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Parameters for familiarization procedure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    % BUTTONS
    
    xoffset = 0.05;
    yoffset = 0.05;
    nButtons = 5;
    widthButton = (1 - 2*xoffset)/nButtons;
    heightButton = 0.15;

    hndl.wordList = [];
    hndl.nWords = 0;
    
    hndl.PlayCount = 0;
    
    hndl.LeftRight = 0;
   
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% set up experimental screen
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    
    uicontrol('Style','text','String','Choose 1 word, then press "Play". Once satisfied, click "Next".', ...
        'FontWeight', 'bold', ...
        'backgroundcolor',hndl.colors.gray,...
        'FontSize',20,...
        'Units', 'normalized', 'Position',[0.05,0.8,0.4,0.075]);

    hndl.ExpButtons.Play = uicontrol('Style', 'pushbutton', ...
        'String', 'Play', ...
        'FontWeight', 'bold', ...
        'FontSize', 40, ...
        'Enable','off',...
        'backgroundcolor',[1 1 1], ...
        'callback',{@Play}, ...
        'Units', 'normalized', 'Position',[0.55,0.8,0.3,0.15]);

    % Row 1

    hndl.ExpButtons.Word1 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{1},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,1}, ...
        'Units', 'normalized', 'Position',[xoffset,yoffset+3*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word2 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{2},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,2}, ...
        'Units', 'normalized', 'Position',[xoffset+widthButton,yoffset+3*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word3 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{3},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,3}, ...
        'Units', 'normalized', 'Position',[xoffset+2*widthButton,yoffset+3*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word4 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{4},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,4}, ...
        'Units', 'normalized', 'Position',[xoffset+3*widthButton,yoffset+3*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word5 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{5},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,5}, ...
        'Units', 'normalized', 'Position',[xoffset+4*widthButton,yoffset+3*heightButton,...
            widthButton,heightButton]);

    % Row 2

    hndl.ExpButtons.Word6 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{6},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,6}, ...
        'Units', 'normalized', 'Position',[xoffset,yoffset+2*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word7 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{7},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,7}, ...
        'Units', 'normalized', 'Position',[xoffset+widthButton,yoffset+2*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word8 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{8},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,8}, ...
        'Units', 'normalized', 'Position',[xoffset+2*widthButton,yoffset+2*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word9 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{9},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,9}, ...
        'Units', 'normalized', 'Position',[xoffset+3*widthButton,yoffset+2*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word10 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{10},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,10}, ...
        'Units', 'normalized', 'Position',[xoffset+4*widthButton,yoffset+2*heightButton,...
            widthButton,heightButton]);

    % Row 3

    hndl.ExpButtons.Word11 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{11},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,11}, ...
        'Units', 'normalized', 'Position',[xoffset,yoffset+1*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word12 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{12},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,12}, ...
        'Units', 'normalized', 'Position',[xoffset+widthButton,yoffset+1*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word13 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{13},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,13}, ...
        'Units', 'normalized', 'Position',[xoffset+2*widthButton,yoffset+1*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word14 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{14},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,14}, ...
        'Units', 'normalized', 'Position',[xoffset+3*widthButton,yoffset+1*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word15 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{15},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,15}, ...
        'Units', 'normalized', 'Position',[xoffset+4*widthButton,yoffset+1*heightButton,...
            widthButton,heightButton]);
        
    hndl.ExpButtons.Next = uicontrol('Style', 'pushbutton', 'String', 'Next', ...
        'FontWeight', 'bold', ...
        'FontSize', 8, ...
        'FontUnits','normalized',...
        'backgroundcolor',[1 0.1 0.1], ...
        'callback',{@WelcomeScreenHomeDelivery,hndl.npanel}, ...
        'Units', 'normalized', 'Position',[0.885,0.1,0.1,0.052]);

    hndl.ExpButtons.GetHelp = uicontrol('Style', 'pushbutton', 'String', 'Help', ...
        'FontWeight', 'bold', ...
        'FontSize', 8, ...
        'FontUnits','normalized',...
        'backgroundcolor',[1 0.1 0.1], ...
        'callback',{@Help,0}, ...
        'Units', 'normalized', 'Position',[0.115,0.1,0.1,0.052]);

    set(gcf, 'UserData', hndl);
end


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Subfunctions  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% plays stimulus on press of green button
function UpdateResponse(obj,events,input)
    hndl = get(gcf, 'UserData');

    if input > 0
        buttonData = eval(sprintf('get(hndl.ExpButtons.Word%d);',input));
        c = buttonData.BackgroundColor;

        if c == hndl.colors.blue
            eval(sprintf('set(hndl.ExpButtons.Word%d,''BackgroundColor'',hndl.colors.red);',input));
            hndl.wordList = [hndl.wordList input];
        elseif c == hndl.colors.red
            eval(sprintf('set(hndl.ExpButtons.Word%d,''BackgroundColor'',hndl.colors.blue);',input));
            hndl.wordList(hndl.wordList == input) = [];
        end
    end
    
   
    if length(hndl.wordList) ~= 1
        set(hndl.ExpButtons.Play,'BackgroundColor',[1 1 1]);        
        set(hndl.ExpButtons.Play,'Enable','off');
    else
        set(hndl.ExpButtons.Play,'BackgroundColor',hndl.colors.green);
        set(hndl.ExpButtons.Play,'Enable','on');
    end

    set(gcf, 'UserData', hndl);

end
    
function LeftRight(~,~,~)

    hndl = get(gcf, 'UserData');
    hndl.LeftRight=get(hndl.Fig.LeftRight,'Value');
    set(gcf, 'UserData', hndl);
    
end
    
function Play(~,~,~)
    
    hndl = get(gcf, 'UserData');
       vLeft = [zeros(29047,1) zeros(29047,1)];
       yRight =  audioread([hndl.StimulusPath 'Vocoded/100 depth/' ...
            sprintf('%s_1_voc_16_of_16ch_LNN_e_600_comp_100_s_0.wav',...
            hndl.PosWords{hndl.wordList(1)})]);
        vRight = [yRight yRight];    
        vLeft = resample(vLeft,hndl.SRate,44100);
        vRight = resample(vRight,hndl.SRate,44100);
    
    if all(vLeft == 0)
        hndl.TrialStimulus = AddTemporalRamps([vLeft(:,1) vRight(:,2)],...
            hndl.Ramp/1000,hndl.SRate,2);
        hndl.TrialStimulus(:,2) = (hndl.TrialStimulus(:,2) ./ ...
            rms(hndl.TrialStimulus(:,2))) * hndl.CalLeft;
    elseif all(vRight == 0)
        hndl.TrialStimulus = AddTemporalRamps([vLeft(:,1) vRight(:,2)],...
            hndl.Ramp/1000,hndl.SRate,2);
        hndl.TrialStimulus(:,1) = (hndl.TrialStimulus(:,1) ./ ...
            rms(hndl.TrialStimulus(:,1))) * hndl.CalLeft;
    else
        hndl.TrialStimulus = AddTemporalRamps([vLeft(:,1) vRight(:,2)],...
            hndl.Ramp/1000,hndl.SRate,2);
        hndl.TrialStimulus(:,1) = (hndl.TrialStimulus(:,1) ./ ...
            rms(hndl.TrialStimulus(:,1))) * hndl.CalLeft;
        hndl.TrialStimulus(:,2) = (hndl.TrialStimulus(:,2) ./ ...
            rms(hndl.TrialStimulus(:,2))) * hndl.CalLeft;
    end
    
    sound(hndl.TrialStimulus,hndl.SRate);
    
    hndl.PlayCount = hndl.PlayCount + 1;
    
    set(gcf, 'UserData', hndl);
    
    if hndl.PlayCount >= 40
        str.data = {'Just checking in. Is this all making sense?',...
            'If anything is unclear, please click the "Help" button below.',...
            'Otherwise, press "Next" to move on.'};
        str.pos = [0.2 0.3];
        str.siz = [0.6 0.35];

        hndl.npanel = hndl.npanel - 1;
        
        GenGUI(str);
        
    end
    
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% stops/aborts experiment
function StopExp(obj,events,type)    
    close(hndl.ExpFig);
end

function PhonoFus_20AFC(hndl,start)
    % User GUI for familarization protocol
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Show Experimental Screen, Run Experiment
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

if ~exist('start','var')
    start = 0;
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% open experimental screen
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%set(hndl.StartFig,'visible','off');
if ~start
    hndl.ExpFig = figure('name','20AFC',...
        'numbertitle','off',...
        'MenuBar','none',...
        'Visible','on','Units','normalized','Position',[0.,0.,1,1]);
    
    % COLORS
    
    hndl.colors.white=[1 1 1];
    hndl.colors.gray=[0.9255 0.9137 0.8471];
    hndl.colors.green=[0.5 1 0.25];
    hndl.colors.blue=[0.5 0.5 1];
    hndl.colors.red=[1 0.25 0.25];
    hndl.colors.orange = [0.947 0.686 0.098];
    hndl.colors.gray = [0.8 0.8 0.8];
    
    % WORD TO NUMBER MAP
    
    hndl.PosWords = {...%'Cam','Lamb','Ram','Clam','Cram',...
                'Bed','Led','Red','Bled','Bread',...
                'Pay','Lay','Ray','Play','Pray',...
                'Go','Low','Row','Glow','Grow'};
    hndl.wordList = [];
    hndl.nWords = 0;
    hndl.Trial = 1;
    
else
    
    clf(hndl.ExpFig);

    hndl.ExpButtons.GetHelp = uicontrol('Style', 'pushbutton', 'String', 'Help', ...
        'FontWeight', 'bold', ...
        'FontSize', 8, ...
        'FontUnits','normalized',...
        'backgroundcolor',[1 0.1 0.1], ...
        'callback',{@Help,0}, ...
        'Units', 'normalized', 'Position',[0.115,0.1,0.1,0.052]);
    
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Parameters for familiarization procedure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    
    % BUTTONS
    
    xoffset = 0.05;
    yoffset = 0.05;
    nButtons = 5;
    widthButton = (1 - 2*xoffset)/nButtons;
    heightButton = 0.15;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% set up experimental screen
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% %     uicontrol('Style','text','String','I heard:', ...
% %         'FontWeight', 'bold', ...
% %         'backgroundcolor',hndl.colors.gray,...
% %         'FontSize',40,...
% %         'Units', 'normalized', 'Position',[0.2,0.9,0.2,0.075]);
% % 
% %     hndl.ExpButtons.OneWords = uicontrol('Style', 'pushbutton', ...
% %         'String', '1 Word', ...
% %         'FontWeight', 'bold', ...
% %         'FontSize', 40, ...
% %         'backgroundcolor',hndl.colors.blue, ...
% %         'callback',{@UpdateResponse,-1}, ...
% %         'Units', 'normalized', 'Position',[0.1,0.8,0.2,0.1]);
% % 
% %     hndl.ExpButtons.TwoWords = uicontrol('Style', 'pushbutton', ...
% %         'String', '2 Words', ...
% %         'FontWeight', 'bold', ...
% %         'FontSize', 40, ...
% %         'backgroundcolor',hndl.colors.blue, ...
% %         'callback',{@UpdateResponse,-2}, ...
% %         'Units', 'normalized', 'Position',[0.3,0.8,0.2,0.1]);

    uicontrol('Style','text','String','Choose up to 2 words that you heard.', ...
        'FontWeight', 'bold', ...
        'backgroundcolor',hndl.colors.gray,...
        'FontSize',40,...
        'Units', 'normalized', 'Position',[0.05,0.75,0.4,0.2]);

    hndl.ExpButtons.Submit = uicontrol('Style', 'pushbutton', ...
        'String', 'Submit', ...
        'FontWeight', 'bold', ...
        'FontSize', 40, ...
        'Enable','off',...
        'backgroundcolor',[1 1 1], ...
        'callback',{@Submit}, ...
        'Units', 'normalized', 'Position',[0.55,0.8,0.3,0.15]);

    if ~start
        hndl.ExpButtons.Stop = uicontrol('Style', 'pushbutton', 'String', 'Abort', ...
            'FontWeight', 'bold', ...
            'FontSize', 14, ...
            'backgroundcolor',[1 0.1 0.1], ...
            'callback',{@StopExp,0}, ...
            'Units', 'normalized', 'Position',[0.885,0.025,0.1,0.05]);
    end

% %     uicontrol('Style','text','String','They were:', ...
% %         'FontWeight', 'bold', ...
% %         'backgroundcolor',hndl.colors.gray,...
% %         'FontSize',40,...
% %         'Units', 'normalized', ...
% %         'Position',[0.33,yoffset+3*heightButton+0.125,0.3,0.1]);

    % Row 1

    hndl.ExpButtons.Word1 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{1},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,1}, ...
        'Units', 'normalized', 'Position',[xoffset,yoffset+3*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word2 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{2},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,2}, ...
        'Units', 'normalized', 'Position',[xoffset+widthButton,yoffset+3*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word3 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{3},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,3}, ...
        'Units', 'normalized', 'Position',[xoffset+2*widthButton,yoffset+3*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word4 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{4},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,4}, ...
        'Units', 'normalized', 'Position',[xoffset+3*widthButton,yoffset+3*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word5 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{5},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,5}, ...
        'Units', 'normalized', 'Position',[xoffset+4*widthButton,yoffset+3*heightButton,...
            widthButton,heightButton]);

    % Row 2

    hndl.ExpButtons.Word6 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{6},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,6}, ...
        'Units', 'normalized', 'Position',[xoffset,yoffset+2*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word7 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{7},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,7}, ...
        'Units', 'normalized', 'Position',[xoffset+widthButton,yoffset+2*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word8 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{8},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,8}, ...
        'Units', 'normalized', 'Position',[xoffset+2*widthButton,yoffset+2*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word9 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{9},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,9}, ...
        'Units', 'normalized', 'Position',[xoffset+3*widthButton,yoffset+2*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word10 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{10},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,10}, ...
        'Units', 'normalized', 'Position',[xoffset+4*widthButton,yoffset+2*heightButton,...
            widthButton,heightButton]);

    % Row 3

    hndl.ExpButtons.Word11 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{11},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,11}, ...
        'Units', 'normalized', 'Position',[xoffset,yoffset+1*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word12 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{12},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,12}, ...
        'Units', 'normalized', 'Position',[xoffset+widthButton,yoffset+1*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word13 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{13},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,13}, ...
        'Units', 'normalized', 'Position',[xoffset+2*widthButton,yoffset+1*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word14 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{14},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,14}, ...
        'Units', 'normalized', 'Position',[xoffset+3*widthButton,yoffset+1*heightButton,...
            widthButton,heightButton]);

    hndl.ExpButtons.Word15 = uicontrol('Style', 'pushbutton', ...
        'FontWeight', 'bold', ...
        'String',hndl.PosWords{15},...
        'FontSize', 40, ...
        'backgroundcolor',hndl.colors.blue, ...
        'Enable','on', ...
        'callback',{@UpdateResponse,15}, ...
        'Units', 'normalized', 'Position',[xoffset+4*widthButton,yoffset+1*heightButton,...
            widthButton,heightButton]);

    % % Row 4
    %     
    % hndl.ExpButtons.Word16 = uicontrol('Style', 'pushbutton', ...
    %     'FontWeight', 'bold', ...
    %     'String',hndl.PosWords{16},...
    %     'FontSize', 40, ...
    %     'backgroundcolor',hndl.colors.blue, ...
    %     'Enable','on', ...
    %     'callback',{@UpdateResponse,16}, ...
    %     'Units', 'normalized', 'Position',[xoffset,yoffset+0*heightButton,...
    %         widthButton,heightButton]);
    % 
    % hndl.ExpButtons.Word17 = uicontrol('Style', 'pushbutton', ...
    %     'FontWeight', 'bold', ...
    %     'String',hndl.PosWords{17},...
    %     'FontSize', 40, ...
    %     'backgroundcolor',hndl.colors.blue, ...
    %     'Enable','on', ...
    %     'callback',{@UpdateResponse,17}, ...
    %     'Units', 'normalized', 'Position',[xoffset+widthButton,yoffset+0*heightButton,...
    %         widthButton,heightButton]);
    % 
    % hndl.ExpButtons.Word18 = uicontrol('Style', 'pushbutton', ...
    %     'FontWeight', 'bold', ...
    %     'String',hndl.PosWords{18},...
    %     'FontSize', 40, ...
    %     'backgroundcolor',hndl.colors.blue, ...
    %     'Enable','on', ...
    %     'callback',{@UpdateResponse,18}, ...
    %     'Units', 'normalized', 'Position',[xoffset+2*widthButton,yoffset+0*heightButton,...
    %         widthButton,heightButton]);
    % 
    % hndl.ExpButtons.Word19 = uicontrol('Style', 'pushbutton', ...
    %     'FontWeight', 'bold', ...
    %     'String',hndl.PosWords{19},...
    %     'FontSize', 40, ...
    %     'backgroundcolor',hndl.colors.blue, ...
    %     'Enable','on', ...
    %     'callback',{@UpdateResponse,19}, ...
    %     'Units', 'normalized', 'Position',[xoffset+3*widthButton,yoffset+0*heightButton,...
    %         widthButton,heightButton]);
    %         
    % hndl.ExpButtons.Word20 = uicontrol('Style', 'pushbutton', ...
    %     'FontWeight', 'bold', ...
    %     'String',hndl.PosWords{20},...
    %     'FontSize', 40, ...
    %     'backgroundcolor',hndl.colors.blue, ...
    %     'Enable','on', ...
    %     'callback',{@UpdateResponse,20}, ...
    %     'Units', 'normalized', 'Position',[xoffset+4*widthButton,yoffset+0*heightButton,...
    %         widthButton,heightButton]);

    %     hndl.TDT = TDTInit(48000);
    %     % set PA5 attenuation
    %     atten = [19.7 19.4];
    %     % TRO - 5 dB
    %     atten = [24.7 24.4];
    %     TDTSetPA5Atten(hndl.TDT,atten);
    
    % Create progress bar
    uicontrol('Style','text','String','Progress', ...
            'FontWeight', 'bold', ...
            'backgroundcolor',hndl.colors.white,...
            'FontSize',20,...
            'Units', 'normalized',...
            'Position',[0.425 0.71 ...
            0.15 0.05]);
    uicontrol('Style','text','String','', ...
        'FontWeight', 'bold', ...
        'backgroundcolor',hndl.colors.white,...
        'FontSize',10,...
        'Units', 'normalized',...
        'Position',[0.05 0.675 ...
        0.9 0.05]);
    uicontrol('Style','text','String','', ...
        'FontWeight', 'bold', ...
        'backgroundcolor',hndl.colors.orange,...
        'FontSize',10,...
        'Units', 'normalized',...
        'Position',[0.05 0.675 ...
        0.9*hndl.Trial/size(hndl.Conditions,1) 0.05]);

    set(gcf, 'UserData', hndl);
end


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Subfunctions  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% plays stimulus on press of green button
    function UpdateResponse(obj,events,input)
    hndl = get(gcf, 'UserData');

    if input > 0
        buttonData = eval(sprintf('get(hndl.ExpButtons.Word%d);',input));
        c = buttonData.BackgroundColor;

        if c == hndl.colors.blue
            eval(sprintf('set(hndl.ExpButtons.Word%d,''BackgroundColor'',hndl.colors.red);',input));
            hndl.wordList = [hndl.wordList input];
        elseif c == hndl.colors.red
            eval(sprintf('set(hndl.ExpButtons.Word%d,''BackgroundColor'',hndl.colors.blue);',input));
            hndl.wordList(hndl.wordList == input) = [];
        end
    elseif input < 0
% %         buttonDataOneWords = get(hndl.ExpButtons.OneWords);
% %         buttonDataTwoWords = get(hndl.ExpButtons.TwoWords);
% %         if input == -1
% %             c = buttonDataOneWords.BackgroundColor;            
% %             if c == hndl.colors.blue
% %                 hndl.nWords = 1;
% %                 set(hndl.ExpButtons.OneWords,'BackgroundColor',hndl.colors.red);
% %                 set(hndl.ExpButtons.TwoWords,'BackgroundColor',hndl.colors.blue);
% %             elseif c == hndl.colors.red
% %                 hndl.nWords = 0;
% %                 set(hndl.ExpButtons.OneWords,'BackgroundColor',hndl.colors.blue);
% %             end
% %         elseif input == -2
% %             c = buttonDataTwoWords.BackgroundColor;            
% %             if c == hndl.colors.blue
% %                 hndl.nWords = 2;
% %                 set(hndl.ExpButtons.TwoWords,'BackgroundColor',hndl.colors.red);
% %                 set(hndl.ExpButtons.OneWords,'BackgroundColor',hndl.colors.blue);
% %             elseif c == hndl.colors.red
% %                 hndl.nWords = 0;
% %                 set(hndl.ExpButtons.TwoWords,'BackgroundColor',hndl.colors.blue);
% %             end
% %         end
    end
    
    
% %     if length(hndl.wordList) ~= hndl.nWords
    if length(hndl.wordList) > 2 || isempty(hndl.wordList)
        set(hndl.ExpButtons.Submit,'BackgroundColor',[1 1 1]);        
        set(hndl.ExpButtons.Submit,'Enable','off');
% %     elseif hndl.nWords == 0
% % % %         % Do nothing - sub has not chosen yet
    else
        set(hndl.ExpButtons.Submit,'BackgroundColor',hndl.colors.green);
        set(hndl.ExpButtons.Submit,'Enable','on');
    end
    
    
    
    set(gcf, 'UserData', hndl);
    
    
    
    
    
%     
%     if input ~= 0
%         stim = AddWaveformITD([hndl.PT hndl.PT],sign(input)*...
%             hndl.PracticeITDs(abs(input)),hndl.SRate);
%     else
%         stim = AddWaveformITD([hndl.PT hndl.PT],0,hndl.SRate);
%     end
%     
% %    Add noise
%         Nx = length(stim);
%         [noise,SRate]=audioread('..\Stimuli\LFDichoticNoise2.wav');
% %        [noise,SRate]=audioread('../Stimuli/LFDichoticNoise2.wav'); % Mac
%         noise=resample(noise,hndl.SRate,SRate);
%         Nnoise = length(noise);
%         noise = noise * 10^(15.7/20); % start w/ 20 dB quieter noise
% 
% 
%         Npad = ceil((Nnoise - Nx)/2);
%         padder = zeros(Npad,2);
%         stim = [padder;stim;padder];
%         stim = stim(1:Nnoise,:);
%         stim = stim + noise;
%         
%         stim = AddTemporalRamps(stim,10/1000,hndl.SRate,2);
%     
% 
% %         if hndl.TDT.on == 0
% %             stim=[stim(:,2) stim(:,1)];
% %             soundsc(stim,48000)
%     %         wavplay(x,hndl.SRate);
%     %         wavplay(x,SRate);
% %         else
%     %         TDTPlayBlocking(hndl.TDT,x,[1 2],hndl.SRate);
%             TDTPlayBlocking(hndl.TDT,stim,[1 2],hndl.SRate);
% %        end
    
    end
    
    
    function Submit(~,~,~)
    
        hndl = get(gcf, 'UserData'); % get variables structure

        for ii = 1:length(hndl.PosWords)
            eval(sprintf('set(hndl.ExpButtons.Word%d,''BackgroundColor'',hndl.colors.blue);',ii));
        end
% %         set(hndl.ExpButtons.OneWords,'BackgroundColor',hndl.colors.blue);
% %         set(hndl.ExpButtons.TwoWords,'BackgroundColor',hndl.colors.blue);
        
        PhonoFus_UpdateScore;
    
    end
    
    function UseTDT(varargin)

        hndl = get(gcf, 'UserData');

    %     if hndl.UseTDT==1
        % initialize the TDT
        hndl.TDT = TDTInit(48000);
        % set PA5 attenuation
        atten = [19.7 19.4]; % dB
        TDTSetPA5Atten(hndl.TDT,atten);
    %         hndl.TDT.on = 1;
    %     else
        % close TDT hardware
        %TDTClose(hndl.TDT);
        hndl.TDT.on = 0;
    %     end

        set(gcf, 'UserData', hndl);

    end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% stops/aborts experiment
    function StopExp(obj,events,type)    
        hndl = get(gcf, 'UserData'); % get variables structure
        close(hndl.ExpFig);
        fclose(hndl.fid);
        hndl.RunNum = hndl.RunNum + 1;
        set(hndl.Fig.RunNum,'string',num2str(hndl.RunNum));
        set(gcf, 'UserData', hndl);
    end